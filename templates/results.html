<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>13F Comparison Results - CIK {{ cik }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>üìä 13F Comparison Results</h1>
                <p>CIK: {{ cik }}</p>
            </div>
            <a href="/logout" class="logout-btn">üîì Logout</a>
        </header>

        {% if dev_mode_no_auth %}
        <div class="dev-banner">
            ‚ö†Ô∏è DEV MODE: Authentication disabled for local development
        </div>
        {% endif %}

        <div class="metadata-card">
            <div class="metadata-item">
                <span class="label">Current Filing:</span>
                <span class="value">{{ metadata.current_date }}</span>
                <span class="sublabel">(Report Date: {{ metadata.current_report_date }})</span>
            </div>
            <div class="metadata-item">
                <span class="label">Prior Filing:</span>
                <span class="value">{{ metadata.prior_date }}</span>
                <span class="sublabel">(Report Date: {{ metadata.prior_report_date }})</span>
            </div>
        </div>

        <div class="summary-card">
            <h2>Summary Statistics</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value">{{ summary.total_positions }}</div>
                    <div class="stat-label">Total Positions</div>
                </div>
                <div class="stat-box stat-new">
                    <div class="stat-value">{{ summary.new_positions }}</div>
                    <div class="stat-label">New</div>
                </div>
                <div class="stat-box stat-exited">
                    <div class="stat-value">{{ summary.exited_positions }}</div>
                    <div class="stat-label">Exited</div>
                </div>
                <div class="stat-box stat-increased">
                    <div class="stat-value">{{ summary.increased_positions }}</div>
                    <div class="stat-label">Increased</div>
                </div>
                <div class="stat-box stat-decreased">
                    <div class="stat-value">{{ summary.decreased_positions }}</div>
                    <div class="stat-label">Decreased</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">{{ summary.unchanged_positions }}</div>
                    <div class="stat-label">Unchanged</div>
                </div>
            </div>
            <div class="total-value">
                Total Current Value: ${{ "{:,.0f}".format(summary.total_current_value * 1000) }}
            </div>
        </div>

        <div class="table-controls">
            <div class="filter-group">
                <button onclick="filterStatus('all')" class="filter-btn active" data-filter="all">All</button>
                <button onclick="filterStatus('NEW')" class="filter-btn" data-filter="NEW">New</button>
                <button onclick="filterStatus('EXITED')" class="filter-btn" data-filter="EXITED">Exited</button>
                <button onclick="filterStatus('INCREASED')" class="filter-btn" data-filter="INCREASED">Increased</button>
                <button onclick="filterStatus('DECREASED')" class="filter-btn" data-filter="DECREASED">Decreased</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Search company or CUSIP..." class="search-input">
                <span class="search-icon">üîç</span>
            </div>
            
            <button onclick="downloadCSV()" class="btn-secondary" style="margin-left: 10px;">
                üì• CSV
            </button>
        </div>

        <div class="table-container">
            <table id="results-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Company ‚Üï</th>
                        <th onclick="sortTable(1)">Type</th>
                        <th onclick="sortTable(2)">CUSIP</th>
                        <th onclick="sortTable(3)" class="num">Prior Shares ‚Üï</th>
                        <th onclick="sortTable(4)" class="num">Current Shares ‚Üï</th>
                        <th onclick="sortTable(5)" class="num">Œî Shares ‚Üï</th>
                        <th onclick="sortTable(6)" class="num">Œî % Shares ‚Üï</th>
                        <th onclick="sortTable(7)" class="num">Prior Value ($K) ‚Üï</th>
                        <th onclick="sortTable(8)" class="num">Current Value ($K) ‚Üï</th>
                        <th onclick="sortTable(9)" class="num">% Change ‚Üï</th>
                        <th onclick="sortTable(10)" class="num">Prior % PF ‚Üï</th>
                        <th onclick="sortTable(11)" class="num">Curr % PF ‚Üï</th>
                        <th onclick="sortTable(12)" class="num">Œî % PF ‚Üï</th>
                        <th onclick="sortTable(13)">Status ‚Üï</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in comparison %}
                    {% if row.status != 'TOTAL' %}
                    <tr class="status-{{ row.status }}">
                        <td class="company-name">{{ row.issuer }}</td>
                        <td>{{ row.titleOfClass }}</td>
                        <td><code>{{ row.cusip }}</code></td>
                        <td class="num">{{ "{:,}".format(row.prior_shares) if row.prior_shares is not none else '‚Äî' }}</td>
                        <td class="num">{{ "{:,}".format(row.current_shares) if row.current_shares is not none else '‚Äî' }}</td>
                        <td class="num change-{{ 'pos' if row.delta_shares and row.delta_shares > 0 else ('neg' if row.delta_shares and row.delta_shares < 0 else 'zero') }}">
                            {{ "{:+,}".format(row.delta_shares) if row.delta_shares is not none else '‚Äî' }}
                        </td>
                        <td class="num change-{{ 'pos' if row.delta_percent_shares and row.delta_percent_shares > 0 else ('neg' if row.delta_percent_shares and row.delta_percent_shares < 0 else 'zero') }}">
                            {% if row.delta_percent_shares is not none %}
                                {{ "{:+.1f}".format(row.delta_percent_shares) }}%
                            {% elif row.status == 'NEW' %}
                                NEW
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td class="num">{{ "{:,}".format(row.prior_value) if row.prior_value is not none else '‚Äî' }}</td>
                        <td class="num">{{ "{:,}".format(row.current_value) if row.current_value is not none else '‚Äî' }}</td>
                        <td class="num change-{{ 'pos' if row.percent_change and row.percent_change > 0 else ('neg' if row.percent_change and row.percent_change < 0 else 'zero') }}">
                            {% if row.percent_change is not none %}
                                {{ "{:+.1f}".format(row.percent_change) }}%
                            {% else %}
                                NEW
                            {% endif %}
                        </td>
                        <td class="num">{{ row.prior_percent_of_portfolio }}%</td>
                        <td class="num">{{ row.current_percent_of_portfolio }}%</td>
                        <td class="num change-{{ 'pos' if row.change_in_portfolio_pct > 0 else ('neg' if row.change_in_portfolio_pct < 0 else 'zero') }}">
                            {{ "{:+.2f}".format(row.change_in_portfolio_pct) }}%
                        </td>
                        <td>
                            <span class="badge badge-{{ row.status.lower() }}">
                                {{ row.status }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    {% for row in comparison %}
                    {% if row.status == 'TOTAL' %}
                    <tr class="row-total">
                        <td class="company-name">{{ row.issuer }}</td>
                        <td></td>
                        <td></td>
                        <td class="num">‚Äî</td>
                        <td class="num">‚Äî</td>
                        <td class="num">‚Äî</td>
                        <td class="num">‚Äî</td>
                        <td class="num">{{ "{:,}".format(row.prior_value) }}</td>
                        <td class="num">{{ "{:,}".format(row.current_value) }}</td>
                        <td class="num change-{{ 'pos' if row.percent_change > 0 else ('neg' if row.percent_change < 0 else 'zero') }}">
                            {{ "{:+.1f}".format(row.percent_change) }}%
                        </td>
                        <td class="num">100.0%</td>
                        <td class="num">100.0%</td>
                        <td class="num">0.00%</td>
                        <td>
                            <span class="badge badge-unchanged">TOTAL</span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tfoot>
            </table>
        </div>

        <div class="actions">
            <a href="/" class="btn-secondary">‚Üê Compare Another Fund</a>
        </div>

        <footer>
            <p>Built by <strong>Marco Qin</strong> with industry guidance from <strong>Stephen</strong></p>
            <p>Data from SEC EDGAR ‚Ä¢ Values in thousands ($K)</p>
        </footer>
    </div>

    <script>
        // Debounce function to prevent UI freeze on large tables
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Search function
        const searchTable = debounce(function() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('results-table');
            const tbody = table.querySelector('tbody');
            const tr = tbody.getElementsByTagName('tr');

            // Hide table during heavy DOM updates to prevent reflows
            tbody.style.display = 'none';

            for (let i = 0; i < tr.length; i++) {
                const companyTd = tr[i].getElementsByTagName("td")[0];
                const cusipTd = tr[i].getElementsByTagName("td")[2];
                
                if (companyTd && cusipTd) {
                    const companyTxt = companyTd.textContent || companyTd.innerText;
                    const cusipTxt = cusipTd.textContent || cusipTd.innerText;
                    
                    if (companyTxt.toUpperCase().indexOf(filter) > -1 || cusipTxt.toUpperCase().indexOf(filter) > -1) {
                        // Only show if it also matches the current status filter
                        if (currentFilter === 'all' || tr[i].classList.contains('status-' + currentFilter)) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
            
            // Restore display
            tbody.style.display = '';
        }, 300);

        // Filter table by status
        let currentFilter = 'all';
        function filterStatus(status) {
            currentFilter = status;
            const rows = document.querySelectorAll('#results-table tbody tr');
            const searchInput = document.getElementById('searchInput').value.toUpperCase();
            
            rows.forEach(row => {
                const companyTd = row.getElementsByTagName("td")[0];
                const cusipTd = row.getElementsByTagName("td")[2];
                const companyTxt = companyTd.textContent || companyTd.innerText;
                const cusipTxt = cusipTd.textContent || cusipTd.innerText;
                const matchesSearch = searchInput === '' || 
                                    companyTxt.toUpperCase().indexOf(searchInput) > -1 || 
                                    cusipTxt.toUpperCase().indexOf(searchInput) > -1;

                if (status === 'all') {
                    row.style.display = matchesSearch ? '' : 'none';
                } else {
                    row.style.display = (row.classList.contains('status-' + status) && matchesSearch) ? '' : 'none';
                }
            });

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === status) {
                    btn.classList.add('active');
                }
            });
        }

        // Sort table by column
        let sortDirection = 1;
        function sortTable(colIndex) {
            const table = document.getElementById('results-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Filter visible rows only
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            
            visibleRows.sort((a, b) => {
                let aVal = a.cells[colIndex].textContent.trim();
                let bVal = b.cells[colIndex].textContent.trim();
                
                // Handle numeric columns
                if (colIndex >= 3 && colIndex <= 12) {
                    aVal = parseFloat(aVal.replace(/[,+%]/g, '').replace('‚Äî', '0')) || 0;
                    bVal = parseFloat(bVal.replace(/[,+%]/g, '').replace('‚Äî', '0')) || 0;
                    return (aVal - bVal) * sortDirection;
                }
                
                // Handle text columns
                return aVal.localeCompare(bVal) * sortDirection;
            });
            
            sortDirection *= -1;
            
            // Re-append rows in new order
            visibleRows.forEach(row => tbody.appendChild(row));
        }

        // Download CSV function
        function downloadCSV() {
            const table = document.getElementById("results-table");
            // Use Array.from to get all rows including the header
            const rows = Array.from(table.querySelectorAll("tr"));
            
            // Filter out hidden rows (if you only want to download visible filtered results)
            // const visibleRows = rows.filter(row => row.style.display !== 'none');
            // For now, let's download EVERYTHING regardless of filter, or just visible?
            // Usually users expect "what I see is what I get", but for data export, all data is often better.
            // Let's stick to "All Data" to ensure completeness, but we can switch to visibleRows if preferred.
            
            let csv = [];
            
            // Get Headers
            const headerRow = table.querySelector("thead tr");
            const headers = Array.from(headerRow.querySelectorAll("th")).map(th => {
                return '"' + th.innerText.replace(' ‚Üï', '').trim() + '"';
            });
            csv.push(headers.join(","));

            // Get Data
            // Skip the first row as it's the header in querySelectorAll("tr") if we selected from table
            // Actually querySelectorAll("tr") includes thead tr. 
            // Let's select only tbody rows and tfoot rows.
            
            const bodyRows = Array.from(table.querySelectorAll("tbody tr"));
            const footerRows = Array.from(table.querySelectorAll("tfoot tr"));
            const allDataRows = [...bodyRows, ...footerRows];

            allDataRows.forEach(row => {
                // Skip if display is none (filtered out) - Uncomment next line to only download visible
                // if (row.style.display === 'none') return;

                const cols = row.querySelectorAll("td");
                let rowData = [];
                
                cols.forEach(col => {
                    // Get text, remove newlines and extra whitespace
                    let data = col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim();
                    // Escape double quotes
                    data = data.replace(/"/g, '""');
                    rowData.push('"' + data + '"');
                });
                csv.push(rowData.join(","));
            });

            const csvString = csv.join("\n");
            const cik = "{{ cik }}";
            const filename = `13F_Comparison_CIK_${cik}.csv`;
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
